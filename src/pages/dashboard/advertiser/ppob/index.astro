---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import InvoiceModal from "../../../../components/dashboard/ppob/InvoiceModal.astro";
import ModeSelector from "../../../../components/dashboard/ppob/ModeSelector.astro";
import PrabayarConfig from "../../../../components/dashboard/ppob/PrabayarConfig.astro";
import PascabayarConfig from "../../../../components/dashboard/ppob/PascabayarConfig.astro";
import PrabayarResults from "../../../../components/dashboard/ppob/PrabayarResults.astro";
import PascabayarResults from "../../../../components/dashboard/ppob/PascabayarResults.astro";
---

<DashboardLayout title="Pesanan Baru - Pulsa & PPOB">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-xl font-bold text-gray-800 tracking-tight">
            Transaksi Baru
        </h1>
        <p class="text-gray-500 text-xs mt-0.5">
            Isi ulang pulsa, data, dan pembayaran tagihan.
        </p>
    </div>

    <!-- Main Container -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
        <!-- LEFT COLUMN: Config -->
        <div class="lg:col-span-5 space-y-4">
            <!-- Mode Selector -->
            <ModeSelector />

            <!-- Configuration Card -->
            <div class="soft-card p-5 border border-gray-100">
                <PrabayarConfig />
                <PascabayarConfig />
            </div>
        </div>

        <!-- RIGHT COLUMN: Results -->
        <div class="lg:col-span-7">
            <PrabayarResults />
            <PascabayarResults />
        </div>
    </div>

    <!-- INVOICE MODAL -->
    <InvoiceModal />
</DashboardLayout>

<script is:inline>
    // State Tracking
    let currentData = {
        mode: "prabayar",
        category: "Token PLN",
        productName: "",
        price: 0,
        number: "",
    };

    // Tab/Mode Logic
    function setMode(mode) {
        currentData.mode = mode;
        const prabayarSection = document.getElementById("config-prabayar");
        const pascabayarSection = document.getElementById("config-pascabayar");
        const prabayarResults = document.getElementById("results-prabayar");
        const pascabayarResults = document.getElementById("results-pascabayar");

        const btnPra = document.getElementById("btn-mode-prabayar");
        const btnPas = document.getElementById("btn-mode-pascabayar");

        if (mode === "prabayar") {
            // Activate Prabayar Button
            btnPra.className =
                "mode-btn active group relative overflow-hidden bg-[#ff6b6b] text-white p-4 rounded-2xl text-left shadow-lg shadow-red-200 transition-all hover:-translate-y-0.5";
            btnPra.innerHTML = `
                <div class="relative z-10 flex flex-col justify-between h-full gap-2">
                     <div class="p-2 bg-white/20 w-fit rounded-lg">
                         <i class="fa-solid fa-mobile-screen-button text-lg"></i>
                     </div>
                     <div>
                         <h3 class="font-bold text-sm leading-tight">Prabayar</h3>
                         <p class="text-[10px] text-white/70 mt-0.5">Isi Ulang</p>
                     </div>
                </div>`;

            // Deactivate Pascabayar Button
            btnPas.className =
                "mode-btn relative overflow-hidden bg-white border border-gray-200 text-gray-500 p-4 rounded-2xl text-left transition-all hover:border-[#ff6b6b] hover:text-[#ff6b6b] hover:-translate-y-0.5";
            btnPas.innerHTML = `
                <div class="relative z-10 flex flex-col justify-between h-full gap-2">
                     <div class="p-2 bg-gray-50 w-fit rounded-lg">
                         <i class="fa-solid fa-file-invoice text-lg"></i>
                     </div>
                     <div>
                         <h3 class="font-bold text-sm leading-tight">Pascabayar</h3>
                         <p class="text-[10px] text-gray-400 mt-0.5">Tagihan</p>
                     </div>
                </div>`;

            // Show/Hide Sections
            prabayarSection.classList.remove("hidden");
            pascabayarSection.classList.add("hidden");
            prabayarResults.classList.remove("hidden");
            pascabayarResults.classList.add("hidden");
        } else {
            // Activate Pascabayar Button
            btnPas.className =
                "mode-btn active group relative overflow-hidden bg-[#ff6b6b] text-white p-4 rounded-2xl text-left shadow-lg shadow-red-200 transition-all hover:-translate-y-0.5";
            btnPas.innerHTML = `
                <div class="relative z-10 flex flex-col justify-between h-full gap-2">
                     <div class="p-2 bg-white/20 w-fit rounded-lg">
                         <i class="fa-solid fa-file-invoice text-lg"></i>
                     </div>
                     <div>
                         <h3 class="font-bold text-sm leading-tight">Pascabayar</h3>
                         <p class="text-[10px] text-white/70 mt-0.5">Tagihan</p>
                     </div>
                </div>`;

            // Deactivate Prabayar Button
            btnPra.className =
                "mode-btn relative overflow-hidden bg-white border border-gray-200 text-gray-500 p-4 rounded-2xl text-left transition-all hover:border-[#ff6b6b] hover:text-[#ff6b6b] hover:-translate-y-0.5";
            btnPra.innerHTML = `
                <div class="relative z-10 flex flex-col justify-between h-full gap-2">
                     <div class="p-2 bg-gray-50 w-fit rounded-lg">
                         <i class="fa-solid fa-mobile-screen-button text-lg"></i>
                     </div>
                     <div>
                         <h3 class="font-bold text-sm leading-tight">Prabayar</h3>
                         <p class="text-[10px] text-gray-400 mt-0.5">Isi Ulang</p>
                     </div>
                </div>`;

            // Show/Hide Sections
            pascabayarSection.classList.remove("hidden");
            prabayarSection.classList.add("hidden");
            pascabayarResults.classList.remove("hidden");
            prabayarResults.classList.add("hidden");
        }
    }

    // Category Selection Prabayar
    function selectCategory(el) {
        document.querySelectorAll(".cat-btn").forEach((btn) => {
            btn.classList.remove(
                "border-[#ff6b6b]",
                "text-[#ff6b6b]",
                "shadow-sm",
                "active",
            );
            btn.classList.add("border-gray-200", "text-gray-400");
        });
        el.classList.remove("border-gray-200", "text-gray-400");
        el.classList.add(
            "border-[#ff6b6b]",
            "text-[#ff6b6b]",
            "shadow-sm",
            "active",
        );

        currentData.category = el.querySelector("span").innerText;
    }

    // Category Selection Pascabayar
    function selectCategoryPasca(el) {
        document.querySelectorAll(".cat-pasca-btn").forEach((btn) => {
            btn.classList.remove(
                "border-[#ff6b6b]",
                "text-[#ff6b6b]",
                "shadow-sm",
                "active",
            );
            btn.classList.add("border-gray-200", "text-gray-400");
        });
        el.classList.remove("border-gray-200", "text-gray-400");
        el.classList.add(
            "border-[#ff6b6b]",
            "text-[#ff6b6b]",
            "shadow-sm",
            "active",
        );

        currentData.category = el.querySelector("span").innerText;
    }

    // Product Selection Logic
    function selectProduct(element, price) {
        document.querySelectorAll(".product-card").forEach((el) => {
            el.classList.remove("border-[#ff6b6b]", "shadow-md");
            el.classList.add("border-gray-200");
            el.querySelector(".opacity-0")?.classList.remove("opacity-100");
        });

        element.classList.remove("border-gray-200");
        element.classList.add("border-[#ff6b6b]", "shadow-md");
        element.querySelector(".opacity-0").classList.add("opacity-100");

        // Update Data
        currentData.price = price;
        currentData.productName =
            element.querySelector("p.text-base").innerText;

        const formatter = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
        });
        document.getElementById("total-price").innerText =
            formatter.format(price);

        const btn = document.getElementById("btn-checkout");
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-not-allowed");
        btn.onclick = showInvoice;
    }

    // Invoice Logic
    function showInvoice() {
        const inputId =
            currentData.mode === "prabayar"
                ? "#config-prabayar input"
                : "#config-pascabayar input";
        currentData.number = document.querySelector(inputId).value || "-";

        document.getElementById("inv-service").innerText = currentData.category;
        document.getElementById("inv-number").innerText = currentData.number;
        document.getElementById("inv-product").innerText =
            `Nominal ${currentData.productName}`;

        const formatter = new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
        });
        document.getElementById("inv-total").innerText = formatter.format(
            currentData.price,
        );

        document.getElementById("invoice-modal").classList.remove("hidden");
    }

    function closeInvoice() {
        document.getElementById("invoice-modal").classList.add("hidden");
    }
</script>

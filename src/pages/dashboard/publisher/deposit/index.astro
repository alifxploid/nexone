---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import DepositStatus from "../../../../components/dashboard/deposit/DepositStatus.astro";

// Mock Data
const currentBalance = 2500000;

const paymentMethods = [
    { name: "QRIS", icon: "qr-code", fee: "0.7%" },
    { name: "Virtual Account", icon: "building-library", fee: "Rp 2.500" },
    { name: "E-Wallet", icon: "wallet", fee: "1.5%" },
];
---

<DashboardLayout title="Deposit Saldo">
    <!-- Header -->
    <div
        class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4"
    >
        <div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">
                Deposit Saldo
            </h1>
            <p class="text-gray-500 text-sm mt-1">
                Isi saldo akun Anda untuk memulai transaksi.
            </p>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">
        <!-- LEFT COLUMN (Form) - lg:col-span-8 -->
        <div class="lg:col-span-8 space-y-6">
            <!-- Balance Card -->
            <div
                class="soft-card p-6 md:p-8 border border-gray-100 relative overflow-hidden group"
            >
                <div
                    class="relative z-10 flex flex-col h-full justify-between gap-6"
                >
                    <div class="flex justify-between items-start">
                        <div class="p-3 bg-gray-100 text-gray-600 rounded-xl">
                            <i class="fa-solid fa-wallet text-xl"></i>
                        </div>
                        <span
                            class="px-3 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold rounded-full"
                            >Target Saldo</span
                        >
                    </div>

                    <div>
                        <p
                            class="text-gray-400 font-bold text-xs uppercase tracking-wider mb-2"
                        >
                            Saldo Saat Ini
                        </p>
                        <h2
                            class="text-4xl md:text-5xl font-black text-gray-800 tracking-tight"
                        >
                            Rp 2.500<span class="text-gray-300">.000</span>
                        </h2>
                        <div class="mt-4 flex items-center gap-2">
                            <div
                                class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden"
                            >
                                <div
                                    class="h-full bg-gray-800 w-[65%] rounded-full"
                                >
                                </div>
                            </div>
                            <span class="text-xs font-bold text-gray-400"
                                >65%</span
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deposit Form Card -->
            <div class="soft-card p-6 md:p-8">
                <h3 class="text-lg font-bold text-gray-800 mb-6">
                    Metode Pembayaran
                </h3>

                <!-- Method Selection -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                    {
                        paymentMethods.map((m) => (
                            <button
                                type="button"
                                class="method-btn relative group p-4 rounded-xl border border-gray-200 bg-white hover:border-gray-300 hover:shadow-md transition-all text-left"
                                onclick={`selectMethod(this, '${m.name}')`}
                            >
                                <div class="mb-3 text-gray-400 group-hover:text-gray-800 transition-colors method-icon flex justify-between items-start">
                                    {m.icon === "qr-code" && (
                                        <i class="fa-solid fa-qrcode text-2xl" />
                                    )}
                                    {m.icon === "building-library" && (
                                        <i class="fa-solid fa-building-columns text-2xl" />
                                    )}
                                    {m.icon === "wallet" && (
                                        <i class="fa-solid fa-wallet text-2xl" />
                                    )}
                                    <div class="w-5 h-5 rounded-full bg-gray-800 text-white flex items-center justify-center opacity-0 scale-50 transition-all check-icon">
                                        <i class="fa-solid fa-check text-[10px]" />
                                    </div>
                                </div>
                                <p class="font-bold text-sm text-gray-800">
                                    {m.name}
                                </p>
                                <p class="text-[10px] text-gray-400 font-medium mt-0.5">
                                    Fee: {m.fee}
                                </p>
                            </button>
                        ))
                    }
                </div>

                <form class="space-y-6" onsubmit="return false;">
                    <!-- Amount Input -->
                    <div class="space-y-2">
                        <label
                            class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1"
                            >Nominal Deposit</label
                        >
                        <div class="relative">
                            <span
                                class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 font-bold pointer-events-none text-xl"
                                >Rp</span
                            >
                            <input
                                type="number"
                                id="deposit-amount"
                                class="w-full bg-gray-50 text-gray-800 font-black text-2xl pl-14 pr-6 py-4 rounded-xl border border-gray-200 focus:border-gray-400 focus:bg-white transition-all outline-none placeholder:text-gray-300"
                                placeholder="0"
                            />
                        </div>
                        <div class="flex gap-2 justify-end">
                            <span class="text-[10px] text-gray-400 font-bold"
                                >Min: Rp 10.000</span
                            >
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-6 border-t border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-sm font-bold text-gray-500"
                                >Total Pembayaran</span
                            >
                            <h3
                                class="text-2xl font-black text-gray-800"
                                id="total-payment"
                            >
                                Rp 0
                            </h3>
                        </div>
                        <button
                            type="button"
                            onclick="processDeposit()"
                            class="w-full py-4 bg-[#ff6b6b] hover:bg-[#e55a5a] text-white font-bold rounded-xl shadow-lg shadow-red-100 transition-all flex items-center justify-center gap-2 text-base transform active:scale-[0.98]"
                        >
                            <i class="fa-solid fa-paper-plane"></i>
                            Bayar Sekarang
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- RIGHT COLUMN (Info) - lg:col-span-4 -->
        <div class="lg:col-span-4 space-y-6">
            <!-- Info Box -->
            <div class="soft-card p-6 border border-blue-100 bg-blue-50/50">
                <div class="flex items-start gap-4">
                    <div class="p-2 bg-blue-100 text-blue-500 rounded-lg">
                        <i class="fa-solid fa-circle-info"></i>
                    </div>
                    <div>
                        <h4 class="text-gray-800 font-bold text-sm mb-1">
                            Informasi Deposit
                        </h4>
                        <ul
                            class="text-gray-500 text-xs space-y-2 list-disc pl-4 leading-relaxed"
                        >
                            <li>
                                Deposit diproses secara otomatis oleh sistem 24
                                jam non-stop.
                            </li>
                            <li>Minimal deposit adalah Rp 10.000.</li>
                            <li>
                                Pastikan nominal transfer sesuai hingga 3 digit
                                terakhir (jika ada kode unik).
                            </li>
                            <li>Simpan bukti transfer jika terjadi kendala.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quick Actions (Optional) -->
            <div class="soft-card p-6">
                <h4 class="text-gray-800 font-bold text-sm mb-4">
                    Butuh Bantuan?
                </h4>
                <button
                    class="w-full py-3 border border-gray-200 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                >
                    <i class="fa-brands fa-whatsapp text-lg text-emerald-500"
                    ></i>
                    Hubungi Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <DepositStatus />

    <script is:inline>
        let currentAmount = 0;
        let selectedMethod = "";
        const currentBalance = 2500000;

        // --- CORE FUNCTIONS ---

        function moveModalsToBody() {
            const ids = ["deposit-status-modal"];
            ids.forEach((id) => {
                const el = document.getElementById(id);
                if (el && el.parentElement !== document.body) {
                    document.body.appendChild(el);
                }
            });
        }

        const amountInput = document.getElementById("deposit-amount");
        if (amountInput) {
            amountInput.addEventListener("input", (e) => {
                currentAmount = parseInt(e.target.value) || 0;
                updateUI();
            });
        }

        function updateUI() {
            // Update Total
            const totalEl = document.getElementById("total-payment");
            if (totalEl)
                totalEl.innerText =
                    "Rp " +
                    new Intl.NumberFormat("id-ID").format(currentAmount);

            // Update Estimated Balance (Optional Implementation)
            /*
            const estEl = document.getElementById("estimated-balance");
            if (estEl) {
                const total = currentBalance + currentAmount;
                const formatted = new Intl.NumberFormat("id-ID").format(total);
                estEl.innerText = "Rp " + formatted;
            }
            */
        }

        function selectMethod(btn, name) {
            document.querySelectorAll(".method-btn").forEach((b) => {
                b.classList.remove(
                    "border-gray-800",
                    "ring-2",
                    "ring-gray-200",
                    "bg-gray-50",
                );
                b.classList.add("border-gray-200", "bg-white");
                const check = b.querySelector(".check-icon");
                if (check) {
                    check.classList.remove("opacity-100", "scale-100");
                    check.classList.add("opacity-0", "scale-50");
                }
            });

            btn.classList.remove("border-gray-200", "bg-white");
            btn.classList.add(
                "border-gray-800",
                "ring-2",
                "ring-gray-200",
                "bg-gray-50",
            );
            const check = btn.querySelector(".check-icon");
            if (check) {
                check.classList.remove("opacity-0", "scale-50");
                check.classList.add("opacity-100", "scale-100");
            }

            selectedMethod = name;
        }

        function processDeposit() {
            if (currentAmount < 10000) {
                showToast("Minimal deposit Rp 10.000", "error");
                return;
            }
            if (!selectedMethod) {
                showToast("Silakan pilih metode pembayaran", "error");
                return;
            }

            toggleModal("deposit-status-modal", true);
            const loading = document.getElementById("status-loading");
            if (loading) {
                loading.classList.remove("hidden");
                loading.classList.add("flex");
            }

            ["status-success", "status-pending", "status-failed"].forEach(
                (id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.add("hidden");
                        el.classList.remove("flex");
                    }
                },
            );

            setTimeout(() => {
                if (loading) {
                    loading.classList.remove("flex");
                    loading.classList.add("hidden");
                }
                const resId = "status-pending"; // Default pending
                const resEl = document.getElementById(resId);
                if (resEl) {
                    resEl.classList.remove("hidden");
                    resEl.classList.add("flex");
                }
            }, 2000);
        }

        // --- HISTORY MODAL LOGIC (reused) ---
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (show) {
                modal.classList.remove("hidden");
                setTimeout(() => {
                    const backdrop = modal.querySelector(
                        "div[id$='-backdrop']",
                    );
                    const panel =
                        modal.querySelector("div[id$='-panel']") ||
                        modal.querySelector("#status-content");
                    if (backdrop)
                        backdrop.classList.replace("opacity-0", "opacity-100");
                    if (panel) {
                        panel.classList.replace("opacity-0", "opacity-100");
                        if (panel.classList.contains("scale-95"))
                            panel.classList.replace("scale-95", "scale-100");
                        if (panel.classList.contains("scale-90"))
                            panel.classList.replace("scale-90", "scale-100");
                    }
                }, 10);
            } else {
                const backdrop = modal.querySelector("div[id$='-backdrop']");
                const panel =
                    modal.querySelector("div[id$='-panel']") ||
                    modal.querySelector("#status-content");
                if (backdrop)
                    backdrop.classList.replace("opacity-100", "opacity-0");
                if (panel) {
                    panel.classList.replace("opacity-100", "opacity-0");
                    if (panel.classList.contains("scale-100"))
                        panel.classList.replace("scale-100", "scale-95");
                }
                setTimeout(() => {
                    modal.classList.add("hidden");
                }, 300);
            }
        }

        window.closeStatusModal = function () {
            toggleModal("deposit-status-modal", false);
        };

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = "success") {
            // Remove existing
            const existing = document.getElementById("dynamic-toast");
            if (existing) existing.remove();

            // Create Element
            const toast = document.createElement("div");
            toast.id = "dynamic-toast";

            const isError = type === "error";
            const iconColor = isError ? "text-red-500" : "text-gray-800";
            const bgColor = isError ? "bg-red-50" : "bg-gray-100";
            const borderColor = isError ? "border-red-100" : "border-gray-200";
            const title = isError ? "Gagal" : "Berhasil";
            const iconPath = isError
                ? "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                : "M5 13l4 4L19 7";

            // FORCE STYLE with inline style
            toast.style.cssText =
                "position: fixed; top: 24px; right: 24px; z-index: 2147483647 !important; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(-150%); opacity: 0; pointer-events: none;";

            // Mobile adjustment
            if (window.innerWidth < 768) {
                toast.style.left = "50%";
                toast.style.right = "auto";
                toast.style.transform = "translate(-50%, -150%)";
            }

            toast.innerHTML = `
                <div class="bg-white border ${borderColor} text-gray-800 px-5 py-4 rounded-xl shadow-xl flex items-center gap-3 min-w-[300px]">
                    <div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">${title}</h4>
                        <p class="text-[11px] text-gray-400 mt-0.5">${message}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate In
            setTimeout(() => {
                toast.style.opacity = "1";
                toast.style.pointerEvents = "auto";

                if (window.innerWidth < 768) {
                    toast.style.transform = "translate(-50%, 0)";
                } else {
                    toast.style.transform = "translateY(0)";
                }
            }, 50);

            // Animate Out
            setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.pointerEvents = "none";
                if (window.innerWidth < 768) {
                    toast.style.transform = "translate(-50%, -150%)";
                } else {
                    toast.style.transform = "translateY(-150%)";
                }

                setTimeout(() => {
                    if (toast && toast.parentElement) toast.remove();
                }, 500);
            }, 3000);
        }

        document.addEventListener("astro:page-load", () => {
            moveModalsToBody();
        });
        moveModalsToBody();
    </script>
</DashboardLayout>

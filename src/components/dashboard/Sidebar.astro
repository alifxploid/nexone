---
const currentPath = Astro.url.pathname;
const isPublisher = currentPath.startsWith("/dashboard/publisher");
const isAdvertiser = currentPath.startsWith("/dashboard/advertiser");

const publisherMenu = [
    {
        name: "Overview",
        icon: "fa-table-columns",
        href: "/dashboard/publisher",
        active:
            currentPath === "/dashboard/publisher" ||
            currentPath === "/dashboard/publisher/",
    },
    {
        name: "Pulsa & PPOB",
        icon: "fa-mobile-screen-button",
        active: currentPath.startsWith("/dashboard/publisher/ppob"),
        submenu: [
            { name: "Pesanan", href: "/dashboard/publisher/ppob" },
            {
                name: "Riwayat Pesanan",
                href: "/dashboard/publisher/ppob/history",
            },
        ],
    },
    {
        name: "Deposit",
        icon: "fa-wallet",
        active: currentPath.startsWith("/dashboard/publisher/deposit"),
        submenu: [
            { name: "New Deposit", href: "/dashboard/publisher/deposit" },
            {
                name: "Riwayat Deposit",
                href: "/dashboard/publisher/deposit/history",
            },
        ],
    },
    {
        name: "Earnings",
        icon: "fa-chart-pie",
        active: currentPath.startsWith("/dashboard/publisher/earning"),
        submenu: [
            {
                name: "Sosial Booster",
                href: "/dashboard/publisher/earning/social",
            },

            {
                name: "Riwayat Task",
                href: "/dashboard/publisher/earning/history",
            },
        ],
    },
    {
        name: "Withdraw",
        icon: "fa-credit-card",
        href: "/dashboard/publisher/withdraw",
        active: currentPath.startsWith("/dashboard/publisher/withdraw"),
    },
    {
        name: "Share & Earn",
        icon: "fa-share-nodes",
        href: "/dashboard/publisher/referral",
        active: currentPath.startsWith("/dashboard/publisher/referral"),
    },
    {
        name: "Tiket Bantuan",
        icon: "fa-circle-question",
        href: "/dashboard/publisher/ticket",
        active: currentPath.startsWith("/dashboard/publisher/ticket"),
    },
];

const advertiserMenu = [
    {
        name: "Overview",
        icon: "fa-table-columns",
        href: "/dashboard/advertiser",
        active:
            currentPath === "/dashboard/advertiser" ||
            currentPath === "/dashboard/advertiser/",
    },
    {
        name: "Create Campaign",
        icon: "fa-bullhorn",
        active: currentPath.startsWith("/dashboard/advertiser/campaign"),
        submenu: [
            {
                name: "Social Booster",
                href: "/dashboard/advertiser/campaign/social",
            },

            {
                name: "Riwayat Campaign",
                href: "/dashboard/advertiser/campaign/history",
            },
        ],
    },
    {
        name: "Pulsa & PPOB",
        icon: "fa-mobile-screen-button",
        active: currentPath.startsWith("/dashboard/advertiser/ppob"),
        submenu: [
            { name: "Pesanan", href: "/dashboard/advertiser/ppob" },
            {
                name: "Riwayat Pesanan",
                href: "/dashboard/advertiser/ppob/history",
            },
        ],
    },
    {
        name: "Deposit",
        icon: "fa-wallet",
        active: currentPath.startsWith("/dashboard/advertiser/deposit"),
        submenu: [
            { name: "New Deposit", href: "/dashboard/advertiser/deposit" },
            {
                name: "Riwayat Deposit",
                href: "/dashboard/advertiser/deposit/history",
            },
        ],
    },
    {
        name: "Share & Earn",
        icon: "fa-share-nodes",
        href: "/dashboard/advertiser/referral",
        active: currentPath.startsWith("/dashboard/advertiser/referral"),
    },
    {
        name: "Tiket Bantuan",
        icon: "fa-circle-question",
        href: "/dashboard/advertiser/ticket",
        active: currentPath.startsWith("/dashboard/advertiser/ticket"),
    },
];

const menuItems = isAdvertiser ? advertiserMenu : publisherMenu;
const roleLabel = isAdvertiser ? "Advertiser Account" : "Publisher Account";
---

<!-- BEGIN: Sidebar -->
<aside
    id="sidebar"
    class="fixed md:sticky top-0 md:top-4 left-0 h-screen md:h-[calc(100vh-2rem)] w-20 flex flex-col items-center justify-between py-4 z-50 bg-transparent transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-none"
>
    <!-- Top: Logo & Main Nav -->
    <div class="flex flex-col items-center gap-8 w-full">
        <!-- Logo -->
        <a href="/" class="w-12 h-12 rounded-full bg-[#ff6b6b] flex items-center justify-center text-white font-bold text-xl shadow-lg hover:scale-105 transition-transform cursor-pointer">
            N
        </a>

        <!-- Navigation Icons -->
        <nav class="flex flex-col gap-6 bg-white py-6 px-2 rounded-full shadow-lg w-14 items-center">
            {menuItems.map((item) => (
                item.submenu ? (
                    <div class="relative group">
                        <button 
                            class:list={[
                                "sidebar-icon text-lg transition-all duration-200 submenu-toggle",
                                item.active ? "text-[#ff6b6b]" : "text-gray-400 hover:text-[#ff6b6b]"
                            ]}
                            title={item.name}
                        >
                            <i class={`fa-solid ${item.icon}`}></i>
                        </button>
                        <!-- Invisible Bridge to connect icon to submenu -->
                        <div class="absolute left-full top-0 w-6 h-full hidden group-hover:block"></div>
                        <!-- Submenu Tooltip -->
                        <div class="submenu-content absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-white rounded-xl shadow-xl p-2 min-w-[160px] invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200 z-50 border border-gray-100">
                            <p class="text-[10px] font-bold text-gray-400 uppercase px-3 py-1 tracking-wider">{item.name}</p>
                            {item.submenu.map((sub) => {
                                // Exact match OR starts with href followed by "/" (for nested pages)
                                // But NOT if another submenu in same group has a more specific match
                                const isExactMatch = currentPath === sub.href || currentPath === sub.href + "/";
                                const isSubActive = isExactMatch;
                                return (
                                    <a
                                        href={sub.href}
                                        class:list={[
                                            "block px-3 py-2 text-sm font-medium rounded-lg transition-colors",
                                            isSubActive
                                                ? "text-[#ff6b6b] bg-red-50"
                                                : "text-gray-600 hover:text-[#ff6b6b] hover:bg-gray-50"
                                        ]}
                                    >
                                        {sub.name}
                                    </a>
                                );
                            })}
                        </div>
                    </div>
                ) : (
                    <a 
                        href={item.href} 
                        class:list={[
                            "sidebar-icon text-lg transition-all duration-200",
                            item.active ? "text-[#ff6b6b]" : "text-gray-400 hover:text-[#ff6b6b]"
                        ]}
                        title={item.name}
                    >
                        <i class={`fa-solid ${item.icon}`}></i>
                    </a>
                )
            ))}
            
            <div class="w-8 h-[1px] bg-gray-200 my-1"></div>
            
            <a 
                href="/dashboard/publisher/settings" 
                class="sidebar-icon text-lg text-gray-400 hover:text-[#ff6b6b] transition-all duration-200"
                title="Settings"
            >
                <i class="fa-solid fa-gear"></i>
            </a>
        </nav>
    </div>

    <!-- Bottom: Dark/Light Toggle & Logout -->
    <div class="flex flex-col items-center gap-4">


        <!-- Logout -->
        <button class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-gray-400 hover:text-[#ff6b6b] shadow-lg transition-colors">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
        </button>
    </div>
</aside>
<!-- END: Sidebar -->

<script>
    function initSidebar() {
        // Mobile Submenu Toggle
        const submenuToggles = document.querySelectorAll('.submenu-toggle');
        
        submenuToggles.forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const parent = toggle.closest('.group');
                const submenu = parent?.querySelector('.submenu-content');
                
                // Close other submenus first
                document.querySelectorAll('.submenu-content').forEach(el => {
                    if (el !== submenu) {
                        el.classList.remove('!visible', '!opacity-100');
                    }
                });

                // Toggle current submenu
                if (submenu) {
                    submenu.classList.toggle('!visible');
                    submenu.classList.toggle('!opacity-100');
                }
            });
        });

        // Close on click outside
        document.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            if (target && !target.closest('.sidebar-icon') && !target.closest('.submenu-content')) {
                document.querySelectorAll('.submenu-content').forEach(el => {
                    el.classList.remove('!visible', '!opacity-100');
                });
            }
        });
    }

    // Run on init and view transitions
    initSidebar();
    document.addEventListener('astro:page-load', initSidebar);
</script>

<style>
    .sidebar-icon {
        color: #a0a0a0;
        transition: all 0.3s ease;
    }
    .sidebar-icon:hover, .sidebar-icon.active {
        color: #ff6b6b;
    }
</style>
